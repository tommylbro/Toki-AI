<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madison AI</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Third-party library for markdown rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.10/marked.min.js"></script>
    <!-- Firebase CDNs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      window.firebase = {
        initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged,
        getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query
      };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .prose-sm {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        .prose-sm pre {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
        }
        .prose-sm code {
            font-size: 0.8rem;
        }
        .dot-flashing {
            position: relative;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #e2e8f0;
            color: #e2e8f0;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #e2e8f0;
            color: #e2e8f0;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #e2e8f0;
            color: #e2e8f0;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% {
                background-color: #e2e8f0;
            }
            50%, 100% {
                background-color: #4a5568;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="root" class="w-full h-full max-w-4xl"></div>
    <script type="module">
        const { useState, useEffect, useRef } = React;
        const ReactDOM = window.ReactDOM;
        const marked = window.marked;
        const { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } = window.firebase;
        const { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query } = window.firebase;

        // Define global variables with fallbacks
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- API Keys and Models (Change these) ---
        const API_KEY = "";
        const TEXT_MODEL = "gemini-2.5-flash-preview-05-20";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";

        // Helper function to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper function to convert PCM to WAV format
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.byteLength;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');

            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // Audio format (1 = PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // Bits per sample

            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            // Write the PCM data
            const pcmView = new Int16Array(pcmData);
            for (let i = 0; i < pcmView.length; i++) {
                view.setInt16(44 + i * 2, pcmView[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // Helper function for writing strings to a DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Custom Icon Components to replace lucide-react
        const BotIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "M12 8V4H8" }),
                React.createElement('rect', { width: "16", height: "12", x: "4", y: "8", rx: "2" }),
                React.createElement('path', { d: "M2 14h2" }),
                React.createElement('path', { d: "M20 14h2" }),
                React.createElement('path', { d: "M15 13l2 2" }),
                React.createElement('path', { d: "M7 13l-2 2" }),
                React.createElement('path', { d: "M12 18h.01" }),
                React.createElement('path', { d: "M7 21h10" }),
                React.createElement('path', { d: "M12 4v4" })
            )
        );

        const UserIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" }),
                React.createElement('circle', { cx: "12", cy: "7", r: "4" })
            )
        );

        const Volume2Icon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('polygon', { points: "11 5 6 9 2 9 2 15 6 15 11 19 11 5" }),
                React.createElement('path', { d: "M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" })
            )
        );

        const ImageIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('rect', { width: "18", height: "18", x: "3", y: "3", rx: "2", ry: "2" }),
                React.createElement('circle', { cx: "9", cy: "9", r: "2" }),
                React.createElement('path', { d: "m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" })
            )
        );

        const FileTextIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" }),
                React.createElement('path', { d: "M14 2v4a2 2 0 0 0 2 2h4" }),
                React.createElement('path', { d: "M10 9H8" }),
                React.createElement('path', { d: "M16 13H8" }),
                React.createElement('path', { d: "M16 17H8" })
            )
        );

        const CodeIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "m18 16 4-4-4-4" }),
                React.createElement('path', { d: "m6 8-4 4 4 4" }),
                React.createElement('path', { d: "M14.5 4l-5 16" })
            )
        );

        const SendHorizonalIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "m3 3 3 9-3 9 19-9Z" }),
                React.createElement('path', { d: "M6 12h16" })
            )
        );

        const WandIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "M15 4V2" }),
                React.createElement('path', { d: "M15 16v-2" }),
                React.createElement('path', { d: "M17 15h2" }),
                React.createElement('path', { d: "M13 15h-2" }),
                React.createElement('path', { d: "M15 15l-1 1" }),
                React.createElement('path', { d: "M15 15l1 1" }),
                React.createElement('path', { d: "M15 9l-1 1" }),
                React.createElement('path', { d: "M15 9l1 1" }),
                React.createElement('path', { d: "M12 12l-1 1" }),
                React.createElement('path', { d: "M12 12l1 1" }),
                React.createElement('path', { d: "M12 12l-1-1" }),
                React.createElement('path', { d: "M12 12l1-1" }),
                React.createElement('path', { d: "M12 12l-1 1" }),
                React.createElement('path', { d: "M12 12l1 1" }),
                React.createElement('path', { d: "M12 12l-1-1" }),
                React.createElement('path', { d: "M12 12l1-1" })
            )
        );

        const XIcon = ({ size = 24, className = "" }) => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
                React.createElement('path', { d: "M18 6 6 18" }),
                React.createElement('path', { d: "m6 6 12 12" })
            )
        );

        const App = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [imageFile, setImageFile] = useState(null);
            const [isAIGenerating, setIsAIGenerating] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [isCodeMode, setIsCodeMode] = useState(false);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            const messagesEndRef = useRef(null);
            const audioRef = useRef(null);

            useEffect(() => {
                // Initialize Firebase
                try {
                    const app = window.firebase.initializeApp(firebaseConfig);
                    const firestore = window.firebase.getFirestore(app);
                    const firebaseAuth = window.firebase.getAuth(app);
                    setDb(firestore);
                    setAuth(firebaseAuth);

                    // Sign in with custom token or anonymously
                    const signIn = async () => {
                        try {
                            if (initialAuthToken) {
                                await window.firebase.signInWithCustomToken(firebaseAuth, initialAuthToken);
                            } else {
                                await window.firebase.signInAnonymously(firebaseAuth);
                            }
                        } catch (error) {
                            console.error("Firebase sign-in failed:", error);
                        }
                    };
                    signIn();

                    // Set up auth state change listener
                    const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            setUserId(null);
                        }
                        setIsAuthReady(true);
                    });

                    return () => unsubscribe();
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                }
            }, []);

            useEffect(() => {
                if (db && userId && isAuthReady) {
                    const messagesCollectionRef = collection(db, "artifacts/" + appId + "/users/" + userId + "/messages");
                    const q = query(messagesCollectionRef);

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const fetchedMessages = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        const sortedMessages = fetchedMessages.sort(function(a, b) {
                            const timestampA = a.timestamp ? a.timestamp.toMillis() : 0;
                            const timestampB = b.timestamp ? b.timestamp.toMillis() : 0;
                            return timestampA - timestampB;
                        });
                        setMessages(sortedMessages);
                    }, (error) => {
                        console.error("Error fetching messages:", error);
                    });
                    return () => unsubscribe();
                }
            }, [db, userId, isAuthReady, appId]);

            useEffect(() => {
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages]);

            const callGemini = async (prompt) => {
                let responseText = "Sorry, I couldn't get a response from the AI.";
                let retries = 0;
                const maxRetries = 5;
                const initialDelay = 1000; // 1 second

                while (retries < maxRetries) {
                    try {
                        const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/" + TEXT_MODEL + ":generateContent?key=" + API_KEY, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: prompt })
                        });
                        if (response.ok) {
                            const result = await response.json();
                            if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0] && result.candidates[0].content.parts[0].text) {
                                responseText = result.candidates[0].content.parts[0].text;
                            }
                            break; // Exit the retry loop on success
                        } else if (response.status === 429) {
                            // Too Many Requests, implement exponential backoff
                            const delay = initialDelay * Math.pow(2, retries);
                            console.warn(`Rate limit exceeded. Retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retries++;
                        } else {
                            throw new Error(`API returned status code ${response.status}`);
                        }
                    } catch (error) {
                        console.error("Gemini API call failed:", error);
                        responseText = "An error occurred while communicating with the AI.";
                        break; // Exit the retry loop on a non-429 error
                    }
                }

                const aiMessage = { text: responseText, role: 'ai', timestamp: serverTimestamp() };
                if (db && userId) {
                    await addDoc(collection(db, "artifacts/" + appId + "/users/" + userId + "/messages"), aiMessage);
                }
                setIsAIGenerating(false);
            };

            const handleSendMessage = async () => {
                const text = input.trim();
                if (!text && !imageFile) return;

                setIsAIGenerating(true);
                const userMessage = { text, role: 'user', timestamp: serverTimestamp() };
                const promptParts = [];

                if (text) {
                    promptParts.push({ text: text });
                }

                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        const imageData = {
                            inlineData: {
                                mimeType: imageFile.type,
                                data: base64Data
                            }
                        };
                        userMessage.imageUrl = e.target.result;
                        if (db && userId) {
                            await addDoc(collection(db, "artifacts/" + appId + "/users/" + userId + "/messages"), userMessage);
                        }
                        promptParts.push(imageData);
                        await callGemini([{ role: "user", parts: promptParts }]);
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    if (db && userId) {
                        await addDoc(collection(db, "artifacts/" + appId + "/users/" + userId + "/messages"), userMessage);
                    }
                    await callGemini([{ role: "user", parts: promptParts }]);
                }

                setInput('');
                setImageFile(null);
            };

            const handleTextToSpeech = async (text) => {
                if (isSpeaking) return;
                setIsSpeaking(true);

                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    }
                };

                try {
                    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/" + TTS_MODEL + ":generateContent?key=" + API_KEY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    const part = result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0];
                    const audioData = part && part.inlineData && part.inlineData.data;
                    const mimeType = part && part.inlineData && part.inlineData.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);

                        if (audioRef.current) {
                            audioRef.current.pause();
                            URL.revokeObjectURL(audioRef.current.src);
                        }
                        const audio = new Audio(audioUrl);
                        audioRef.current = audio;
                        audio.play();
                        audio.onended = () => {
                            setIsSpeaking(false);
                            URL.revokeObjectURL(audio.src);
                        };
                    } else {
                        throw new Error("Invalid audio data from API.");
                    }
                } catch (error) {
                    console.error("Error generating TTS:", error);
                    setIsSpeaking(false);
                }
            };

            const handleStopSpeaking = () => {
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                    setIsSpeaking(false);
                }
            };

            const handleSummarizeConversation = async () => {
                setIsAIGenerating(true);
                const conversationHistory = messages.map(function(msg) {
                    return (msg.role === 'user' ? 'User' : 'AI') + ": " + msg.text;
                }).join('\n');
                const prompt = "Please summarize the following conversation:\n\n" + conversationHistory;
                const userMessage = { text: "Summarize conversation", role: 'user', timestamp: serverTimestamp() };
                if (db && userId) {
                    await addDoc(collection(db, "artifacts/" + appId + "/users/" + userId + "/messages"), userMessage);
                }
                await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
            };

            const handleContinueWriting = async () => {
                setIsAIGenerating(true);
                const lastUserMessage = messages.slice().reverse().find(msg => msg.role === 'user');
                if (!lastUserMessage) {
                    const aiMessage = { text: "I can't continue writing, as there is no previous message to build upon.", role: 'ai', timestamp: serverTimestamp() };
                    if (db && userId) {
                        await addDoc(collection(db, "artifacts/" + appId + "/users/" + userId + "/messages"), aiMessage);
                    }
                    setIsAIGenerating(false);
                    return;
                }

                const prompt = "Continue writing based on this: " + lastUserMessage.text;
                const userMessage = { text: prompt, role: 'user', timestamp: serverTimestamp() };
                if (db && userId) {
                    await addDoc(collection(db, "artifacts/" + appId + "/users/" + userId + "/messages"), userMessage);
                }
                await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
            };

            const handleRefineWriting = async () => {
                if (!input.trim()) return;

                setIsAIGenerating(true);
                const prompt = "Refine the following text to be more clear, concise, and professional: " + input;
                const userMessage = { text: "Refine: " + input, role: 'user', timestamp: serverTimestamp() };
                if (db && userId) {
                    await addDoc(collection(db, "artifacts/" + appId + "/users/" + userId + "/messages"), userMessage);
                }
                await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
            };

            const handleExplainCode = async () => {
                if (!input.trim()) return;

                setIsAIGenerating(true);
                const prompt = "Explain the following code snippet in detail: " + input;
                const userMessage = { text: "Explain code: " + input, role: 'user', timestamp: serverTimestamp() };
                if (db && userId) {
                    await addDoc(collection(db, "artifacts/" + appId + "/users/" + userId + "/messages"), userMessage);
                }
                await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
            };

            const handleFileChange = (e) => {
                setImageFile(e.target.files[0]);
            };

            const appElement = React.createElement(
                'div',
                { className: 'flex flex-col h-screen bg-gray-800 text-gray-200 w-full max-w-4xl mx-auto rounded-lg shadow-2xl' },
                React.createElement(
                    'div',
                    { className: 'flex-grow overflow-y-auto p-6 space-y-4' },
                    messages.map((msg, index) => (
                        React.createElement(
                            'div',
                            { key: msg.id || index, className: `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}` },
                            React.createElement(
                                'div',
                                { className: `p-4 rounded-xl max-w-lg ${msg.role === 'user' ? 'bg-blue-600 rounded-br-none' : 'bg-gray-700 rounded-bl-none'}` },
                                React.createElement(
                                    'div',
                                    { className: 'flex items-center space-x-2 mb-2' },
                                    msg.role === 'user' ? React.createElement(UserIcon, { size: 16 }) : React.createElement(BotIcon, { size: 16 }),
                                    React.createElement('span', { className: 'font-semibold' }, msg.role === 'user' ? 'You' : 'Madison AI'),
                                    msg.role === 'ai' && msg.text && (
                                        isSpeaking ? (
                                            React.createElement(
                                                'button',
                                                { onClick: handleStopSpeaking, className: 'text-gray-400 hover:text-white' },
                                                React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
                                                    React.createElement('rect', { x: '6', y: '4', width: '4', height: '16', rx: '1' }),
                                                    React.createElement('rect', { x: '14', y: '4', width: '4', height: '16', rx: '1' })
                                                )
                                            )
                                        ) : (
                                            React.createElement(
                                                'button',
                                                { onClick: function() { handleTextToSpeech(msg.text); }, disabled: isSpeaking, className: 'text-gray-400 hover:text-white disabled:opacity-50' },
                                                React.createElement(Volume2Icon, { size: 16 })
                                            )
                                        )
                                    )
                                ),
                                msg.imageUrl && (
                                    React.createElement(
                                        'div',
                                        { className: 'my-2' },
                                        React.createElement('img', { src: msg.imageUrl, alt: 'Uploaded', className: 'max-w-xs h-auto rounded-lg' })
                                    )
                                ),
                                React.createElement('div', { dangerouslySetInnerHTML: { __html: marked.parse(msg.text) }, className: 'prose prose-sm dark:prose-invert' })
                            )
                        )
                    )),
                    isAIGenerating && (
                        React.createElement(
                            'div',
                            { className: 'flex justify-start' },
                            React.createElement(
                                'div',
                                { className: 'p-4 rounded-xl bg-gray-700 rounded-bl-none max-w-lg' },
                                React.createElement(BotIcon, { size: 16, className: 'inline-block mr-2' }),
                                React.createElement('span', { className: 'font-semibold' }, 'Madison AI'),
                                React.createElement('div', { className: 'dot-flashing ml-2 inline-block' })
                            )
                        )
                    ),
                    React.createElement('div', { ref: messagesEndRef })
                ),
                React.createElement(
                    'div',
                    { className: 'p-4 bg-gray-900 border-t border-gray-700 flex flex-col space-y-2' },
                    imageFile && (
                        React.createElement(
                            'div',
                            { className: 'flex items-center space-x-2 p-2 bg-gray-700 rounded-md' },
                            React.createElement(ImageIcon, { size: 16 }),
                            React.createElement('span', null, imageFile.name),
                            React.createElement(
                                'button',
                                { onClick: function() { setImageFile(null); }, className: 'text-gray-400 hover:text-white ml-auto' },
                                React.createElement(XIcon, { size: 16 })
                            )
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'flex items-center space-x-2' },
                        React.createElement('input', {
                            type: 'text',
                            className: 'flex-grow p-3 rounded-full bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors',
                            value: input,
                            onChange: function(e) { setInput(e.target.value); },
                            onKeyPress: function(e) { e.key === 'Enter' && handleSendMessage(); },
                            placeholder: isCodeMode ? 'Enter code here...' : 'Type a message...',
                            disabled: isAIGenerating || !isAuthReady
                        }),
                        React.createElement(
                            'button',
                            {
                                className: `p-3 rounded-full shadow-lg transition-colors ${isCodeMode ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-700 hover:bg-gray-600'}`,
                                onClick: () => setIsCodeMode(!isCodeMode),
                                disabled: isAIGenerating || !isAuthReady
                            },
                            React.createElement(CodeIcon, { size: 20 })
                        ),
                        React.createElement(
                            'label',
                            { className: 'p-3 bg-purple-600 text-white rounded-full shadow-lg hover:bg-purple-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed' },
                            React.createElement('input', { type: 'file', onChange: handleFileChange, className: 'hidden', accept: 'image/*', disabled: isAIGenerating || !isAuthReady || isCodeMode }),
                            React.createElement(ImageIcon, { size: 20 })
                        ),
                        React.createElement(
                            'button',
                            {
                                className: 'p-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed',
                                onClick: handleSendMessage,
                                disabled: isAIGenerating || isSpeaking || (!input && !imageFile) || !isAuthReady
                            },
                            React.createElement(SendHorizonalIcon, { size: 20 })
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'flex justify-end space-x-2' },
                        React.createElement(
                            'button',
                            {
                                className: 'p-2 bg-yellow-600 text-white rounded-full shadow-lg hover:bg-yellow-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-1',
                                onClick: handleSummarizeConversation,
                                disabled: isAIGenerating || messages.length === 0 || !isAuthReady
                            },
                            React.createElement(FileTextIcon, { size: 16 }),
                            React.createElement('span', { className: 'font-semibold' }, '✨ Summarize')
                        ),
                        React.createElement(
                            'button',
                            {
                                className: 'p-2 bg-green-600 text-white rounded-full shadow-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-1',
                                onClick: handleContinueWriting,
                                disabled: isAIGenerating || messages.length === 0 || messages.find(msg => msg.role === 'user') === undefined || !isAuthReady
                            },
                            React.createElement(WandIcon, { size: 16 }),
                            React.createElement('span', { className: 'font-semibold' }, '✨ Continue Writing')
                        ),
                        isCodeMode ? (
                            React.createElement(
                                'button',
                                {
                                    className: 'p-2 bg-teal-600 text-white rounded-full shadow-lg hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-1',
                                    onClick: handleExplainCode,
                                    disabled: isAIGenerating || !input.trim() || !isAuthReady
                                },
                                React.createElement(CodeIcon, { size: 16 }),
                                React.createElement('span', { className: 'font-semibold' }, '✨ Explain Code')
                            )
                        ) : (
                            React.createElement(
                                'button',
                                {
                                    className: 'p-2 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-1',
                                    onClick: handleRefineWriting,
                                    disabled: isAIGenerating || !input.trim() || !isAuthReady
                                },
                                React.createElement(WandIcon, { size: 16 }),
                                React.createElement('span', { className: 'font-semibold' }, '✨ Refine Writing')
                            )
                        )
                    )
                )
            );
            return appElement;
        };
        ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App, null));
    </script>
</body>
</html>
